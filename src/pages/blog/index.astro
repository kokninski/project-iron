---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import BlogCard from '../../components/BlogCard.astro';
import Footer from '../../components/Footer.astro';
import { getCollection } from 'astro:content';

const PAGE_SIZE = 6;
const { page = 1 } = Astro.url?.searchParams
  ? Object.fromEntries(Astro.url.searchParams)
  : { page: 1 };
const pageNum = Number(page) || 1;
const allPosts = (await getCollection('posts')).sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime(),
);
const totalPages = Math.ceil(allPosts.length / PAGE_SIZE);
const posts = allPosts.slice((pageNum - 1) * PAGE_SIZE, pageNum * PAGE_SIZE);
---

<BaseLayout>
  <Header />
  <main class="container mx-auto py-16">
    <h1 class="text-heading text-4xl font-bold mb-8">Blog</h1>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      {
        posts.map((post) => (
          <BlogCard
            image={post.data.coverImage}
            title={post.data.title}
            excerpt={post.data.excerpt}
            date={post.data.date.toLocaleDateString('pl-PL')}
            author={post.data.author}
            href={`/blog/${post.slug}/`}
          />
        ))
      }
    </div>
    <nav class="flex justify-center gap-2 mt-12" aria-label="Paginacja bloga">
      {
        Array.from({ length: totalPages }, (_, i) => (
          <a
            href={i === 0 ? '/blog/' : `/blog/?page=${i + 1}`}
            class={['btn btn-sm', pageNum === i + 1 ? 'btn-primary' : 'btn-secondary'].join(' ')}
            aria-current={pageNum === i + 1 ? 'page' : undefined}
          >
            {i + 1}
          </a>
        ))
      }
    </nav>
  </main>
  <Footer />
</BaseLayout>
